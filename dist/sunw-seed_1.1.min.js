(function(k,i,b,n){b=k[b]=k[b]?k[b]:function(d){if(/^#/.test(d)){return i.getElementById(d.replace(/^#+/,""))}else{if(/^\./.test(d)){return i.getElementsByClassName(d.replace(/^\.+/,""))}else{return i.getElementsByTagName(d)}}};var g="1.1",a={ERROR_PARAM_TYPE:"param type is unsupported",ERROR_PARAM_NOT_EXISTS:"param [ ? ] does not exist",ERROR_MODULE_BLANK:"module name is blank",ERROR_MODULE_EXISTS:"module [ ? ] exists",ERROR_MODULE_NOT_EXISTS:"module [ ? ] does not exist",ERROR_MODULE_TIMEOUT:"module [ ? ] loaded timeout",ERROR_MODULE_LOAD_FAILED:"module [ ? ] load failed",ERROR_NODE_NOT_INIT:"node [ ? ] is not initialized",ERROR_NODE_LOAD_FAILED:"node [ ? ] load failed"},l={UNLOAD:0,ERROR:1,TIMEOUT:2,LOADING:3,SUCCESS:4},e=(function(){var d=i.getElementsByTagName("script"),q=d[d.length-1];return q.src.replace(/\?.*$/,"").replace(/\/[^\/]+\/*$/,"/")})(),j=false,p=false,m=[],h=function(){var d=false,u=1,r=0,t=n,q=function(v){return v&&typeof v==="object"&&v!=k&&!v.nodeType};if(typeof arguments[0]==="boolean"){d=arguments[0],u=2,r=1}for(;u<arguments.length;u++){for(var s in arguments[u]){if(d&&q(arguments[r][s])&&q(arguments[u][s])){arguments[r][s]=h.call(k,d,arguments[r][s],arguments[u][s])}else{arguments[r][s]=arguments[u][s]}}}return arguments[r]},o={_contactUri:function(){var d=arguments[0]||"";for(var s=1,q=arguments.length;s<q;s++){if(!b.isBlank(arguments[s])){var r=/^\?/.test(arguments[s])?"":"/";d=d.replace(/\/$/,"")+r+arguments[s].replace(/^\//,"")}}return d},getPath:function(d,q){if(b.isBlank(d)||/^\/|((http|https|ftp):\/\/)/.test(q)){return q}while(true){if(/^(\.\/)+/.test(q)){q=q.replace(/^(\.\/)+/,"")}else{if(/^\.\.\//.test(q)){q=q.replace(/^\.\.\//,"");d=d.replace(/\/[^\/]+\/*$/,"/")}else{return o._contactUri(d,q)}}}},getLoadingModules:function(u){var d=[],t={},v=function(x){var z=b.getModuleDependencies(x);if(!(x in t)){t[x]=b.getModule(x,true)._module}for(var y=0,w=z.length;y<w;y++){v(z[y])}return t[x]};for(var s=0,r=u.length;s<r;s++){v(u[s])}for(var q in t){d.push(t[q])}return d},error:function(q,d){throw q.replace("?",d)},toArray:function(d){if(b.isString(d)){return b.isBlank(d)?[]:b.trim(d).split(/\s*,\s*/)}else{if(b.isArray(d)){return d}else{return o.error(a.ERROR_PARAM_TYPE)}}}};h(b,{version:g,base:e,defaults:{base:"",timeout:10000,async:true,charset:"",version:""},State:l,Env:b.Env||{modules:{},State:{}}});h(b,{extend:h,bind:function(r,q,d){if(i.addEventListener){r.addEventListener(q,d,false)}else{r.attachEvent("on"+q,d)}return b},isString:function(d){return typeof d==="string"},isPlainObject:function(d){return typeof d==="object"&&d!=k&&!d.nodeType},isBoolean:function(d){return typeof d==="boolean"},isBlank:function(d){return d==null||(this.isString(d)&&this.trim(d).length==0)},isArray:function(d){return Array.isArray(d)},isFunction:function(d){return typeof d==="function"},trim:function(d){if(this.isString(d)){return d.replace("^\\s*|\\s*$","")}return o.error(a.ERROR_PARAM_TYPE)}});h(b,{getModule:function(q,d){var r;if(!b.isString(q)){return o.error(a.ERROR_PARAM_TYPE)}r=b.Env.modules[b.trim(q)];if(d===true&&!r){return o.error(a.ERROR_MODULE_NOT_EXISTS,q)}return r},getModuleDependencies:function(d){var q=b.getModule(d,true);return q.dependencies},getModuleState:function(d){var q=b.getModule(d,true);return b.Env.State[b.trim(d)]}});h(b,{ready:function(q){var d=this;if(!p){d._bindReady()}if(j){q.call(k,d)}else{m.push(q)}return d},_bindReady:function(){var q=this,d=i.documentElement.doScroll,w=d?"onreadystatechange":"DOMContentLoaded",s="complete",u=function(){q._fireReady()};p=true;if(i.readyState===s){return u()}if(i.addEventListener){function t(){i.removeEventListener(w,t,false),u()}i.addEventListener(w,t,false);k.addEventListener("load",u,false)}else{function r(){if(i.readyState===s){i.detachEvent(w,r)}}i.attachEvent(w,r);k.attachEvent("onload",u);if(k===k.top){(function v(){try{d("left"),u()}catch(x){setTimeout(v,1)}})()}}},_fireReady:function(){if(j){return}j=true;for(var q=0,d=m.length;q<d;q++){m[q].call(k,this)}m=[]}});h(b,{add:function(s,v,q){var r,u="";if(q==n){q=v,v=[]}v=o.toArray(v);if(b.isString(q)){q=o.toArray(q)}if((!b.isPlainObject(s)&&!b.isString(s))||(!b.isFunction(q)&&!b.isArray(q))){return o.error(a.ERROR_PARAM_TYPE)}if(b.isString(s)){s=b.trim(s),r=h(true,{},b.defaults)}else{if(!("name" in s)){return o.error(a.ERROR_PARAM_NOT_EXISTS,"name")}r=h(true,{},b.defaults,s),s=b.trim(s.name),delete r.name}u=o.getPath(e,r.base);if(b.isArray(q)){for(var t=0,d=q.length;t<d;t++){if(b.isString(q[t])){q[t]={url:q[t]}}else{if(b.isPlainObject(q[t])){if(!("url" in q[t])){return o.error(a.ERROR_PARAM_NOT_EXISTS,"url")}}else{return o.error(a.ERROR_PARAM_TYPE)}}q[t].url=o.getPath(u,q[t].url),q[t]=h(true,{},r,q[t]);delete q[t].timeout,delete q[t].base}}if(b.Env.modules[s]){return o.error(a.ERROR_MODULE_EXISTS,s)}delete r.async,delete r.charset,delete r.url;b.Env.modules[s]={config:r,dependencies:v,factory:q};b.Env.modules[s]._module=new c(s);b.Env.State[s]=l.UNLOAD;return b},use:function(s,r){var s=o.toArray(s),t=function(){var v=[b],w=0,u=0;for(w=0,u=s.length;w<u;w++){if(b.getModuleState(s[w])!==l.SUCCESS){return false}}for(w=0,u=s.length;w<u;w++){v.push(b.getModule(s[w],true).result)}if(b.isFunction(r)){r.apply(k,v)}};for(var q=0,d=s.length;q<d;q++){b.getModule(s[q])._module.load(t)}return b}});var f=function(q){var d=this;h(d,q,{state:l.UNLOAD,callback:n,autoLoad:false,_dom:n,_subscribers:[]});d._init()};h(f.prototype,{_init:function(){var q=this,s=b.isBlank(q.version)?q.url:(q.url+(q.url.indexOf("?")<0?"?":"&")+"v="+q.version),d=function(w,v){if(v.isFunction(q.callback)){q.callback.call(q,w,v)}},r=function(){for(var w=0,v=q._subscribers.length;w<v;w++){q._subscribers[w].load.call(q._subscribers[w],q.callback)}},t=function(){q.state=l.SUCCESS;d(true,b);r()},u=function(){q.state=l.ERROR;d(false,b);r()};if(/\.css\??.*$/i.test(q.url)){q._dom=i.createElement("link"),h(q._dom,{rel:"stylesheet",href:s,type:"text/css"})}else{q._dom=i.createElement("script"),h(q._dom,{src:s,type:"text/javascript"});if(b.isBoolean(q.async)){q._dom.async=q.async}}if(!b.isBlank(q.charset)){q._dom.charset=q.charset}b.bind(q._dom,"load",t).bind(q._dom,"error",u)},addSubscribers:function(s){var d=this,t=function(u){if(u instanceof f){d._subscribers.push(u),u.autoLoad=true}};if(b.isArray(s)){for(var r=0,q=s.length;r<q;r++){t(s[r])}}else{t(s)}return d},load:function(q){var d=this;if(!d._dom){return o.error(a.ERROR_NODE_NOT_INIT,d.url)}d.state=l.LOADING,d.callback=q,(i.head||i).appendChild(d._dom)}});var c=function(q){var d=this;h(d,b.Env.modules[q].config,{name:q,callback:[],_result:n,_tid:n,_success:n,_error:n});d._init()};h(c.prototype,{_init:function(){var d=this,q=d.name,r=b.Env.State;h(d,{_success:function(){if(d._tid){clearTimeout(d._tid)}r[q]=l.SUCCESS;d._callback(true,b)},_error:function(){if(d._tid){clearTimeout(d._tid)}r[q]=l.ERROR;d._callback(false,b)},_callback:function(t,s){while(d.callback.length>0){if(s.isFunction(d.callback[0])){d.callback[0].call(d,t,s)}d.callback.shift()}},_addCallback:function(u){if(b.isFunction(u)){d.callback.push(u)}else{if(b.isArray(u)){for(var t=0,s=u.length;t<s;t++){if(b.isFunction(u[t])){d.callback.push(u[t])}}}}return d}})},canLoad:function(){var d=this,r=d.name,t=b.getModuleDependencies(r);for(var s=0,q=t.length;s<q;s++){if(b.getModuleState(t[s])!==l.SUCCESS){return false}}return true},load:function(z){var y=this,A=y.name,w=y.timeout,d=b.Env.State,B=b.Env.modules,v=B[A],x=v.dependencies,r=v.factory;if(d[A]===l.SUCCESS){y._addCallback(z);return y._callback(true,b)}else{if(d[A]===l.LOADING){return y._addCallback(z)}}var u={},s=function(){if(!y.canLoad()){return false}d[A]=l.LOADING;if(!isNaN(w)&&w>0){y._tid=setTimeout(function(){d[A]=l.TIMEOUT,y.callback=[];o.error(a.ERROR_MODULE_TIMEOUT,A)},w)}if(b.isFunction(r)){return y._loadFn(z)}else{return y._loadNodes(z)}};if(x.length>0){for(var t=0,q=x.length;t<q;t++){if(!(x[t] in u)){u[x[t]]=true,B[x[t]]._module.load(s)}}}else{s()}},_loadFn:function(w){var v=this,y=v.name,t=b.getModule(y,true),q=t.factory,u=t.dependencies;v._addCallback(w);var x=[b];for(var r=0,d=u.length;r<d;r++){x.push(b.getModule(u[r],true).result)}try{t.result=q.apply(v,x);v._success()}catch(s){v._error();return o.error(a.ERROR_MODULE_LOAD_FAILED,y)}},_loadNodes:function(w){var v=this,x=v.name,y=b.Env.modules,u=y[x],r=u.factory,d=[],s=function(){var A=true;for(var B=0,z=d.length;B<z;B++){if(d[B].state===l.ERROR){A=false}else{if(d[B].state!==l.SUCCESS){return false}}}if(A){v._success()}else{v._error()}};v._addCallback(w);for(var t=0,q=r.length;t<q;t++){d.push(new f(r[t]))}for(var t=0,q=d.length;t<q;t++){if(d[t].async===false&&t<q-1){d[t].addSubscribers(Array.prototype.slice.call(d,t+1))}if(d[t].autoLoad!==true){d[t].load(s)}}}})})(window,document,"Sunw");
